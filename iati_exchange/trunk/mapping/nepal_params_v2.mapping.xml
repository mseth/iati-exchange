<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<iati-api-mapping>
    <mapping-name>nepal_params_v2</mapping-name>
    <datasource type="postgres">
        <url>localhost:5432/amp_nepal_production</url>
        <username>postgres</username>
        <password>abc</password>
    </datasource>
    <generated-datetime/>
    <iati-activity type="select">-- FULL QUERY WITH SPECIFIC ACTIVITY (4452) FIRST &#xD;
SELECT activity FROM &#xD;
 (&#xD;
 select distinct aor.activity as activity, &#xD;
  CASE WHEN aor.activity = 4452 THEN true ELSE false END as activity_order &#xD;
  from amp_org_role aor, amp_activity a &#xD;
  where aor.role=13 and a.amp_activity_id=aor.activity  &#xD;
   -- On budget activities&#xD;
   AND amp_activity_id IN &#xD;
   (&#xD;
    SELECT a.amp_activity_id &#xD;
     FROM amp_activity_version a, amp_category_value acv,amp_activities_categoryvalues aac &#xD;
     WHERE aac.amp_activity_id = a.amp_activity_id AND aac.amp_categoryvalue_id=acv.id AND &#xD;
     acv.id =253&#xD;
   )&#xD;
   AND amp_activity_id IN &#xD;
   (&#xD;
 &#xD;
   SELECT amp_activity_id FROM v_donor_funding &#xD;
    WHERE  adjustment_type_name='Planned' AND transaction_type=1  &#xD;
     AND transaction_date &gt;= '${startDate} 00:00:00' AND transaction_date &lt; '${endDate} 00:00:00'&#xD;
     &#xD;
   UNION&#xD;
    &#xD;
   SELECT amp_activity_id FROM v_donor_funding &#xD;
    WHERE  adjustment_type_name='Actual' AND transaction_type=1  &#xD;
     AND transaction_date &gt;= '${startDate} 00:00:00' AND transaction_date &lt; '${endDate} 00:00:00'&#xD;
   )&#xD;
 ) as act_list&#xD;
 &#xD;
ORDER BY activity_order DESC, activity DESC;</iati-activity>
    <global-query type="select">select amp_activity_id, amp_id, name from amp_activity where amp_activity_id=$parent;</global-query>
    <mapping>
        <field ref="iati-identifier">
            <content prefix="MoF-" type="column">amp_activity_id</content>
            <query/>
        </field>
        <field ref="other-identifier">
            <content type="column">proj_budget_code</content>
            <attribute type="column" ref="owner-ref">ref</attribute>
            <attribute type="column" ref="owner-name">name</attribute>
            <query>select o.org_code as ref, o.budget_org_code as budget_code, o.name as name, concat(o.budget_org_code, aor.budget_code) as proj_budget_code from amp_organisation o, amp_org_role aor, amp_role ar where aor.activity=$parent and aor.organisation=o.amp_org_id and aor.role = ar.amp_role_id and ar.name='Responsible Organisation';</query>
        </field>
        <field ref="title">
            <content type="column">name</content>
            <attribute type="constant" ref="xml:lang">en</attribute>
            <query/>
        </field>
        <field ref="participating-org">
            <content type="column">org_name</content>
            <attribute type="column" ref="ref">org_code</attribute>
            <attribute type="column" ref="role">role</attribute>
            <attribute type="constant" ref="xml:lang">en</attribute>
            <query>select distinct case when ar.role_code = 'DN' then 'Funding' else 'Accountable' END as role, o.name as org_name, o.org_code as org_code, o.budget_org_code as budget_code  from amp_org_role aor, amp_organisation o, amp_role ar where aor.activity=$parent and o.amp_org_id = aor.organisation and aor.role = ar.amp_role_id and ar.role_code in ('DN','RO');</query>
        </field>
        <field ref="planned-disbursement">
            <content type="constant">novalue</content>
            <query>-- Planned Disbursements&#xD;
SELECT fund_temp.*, min_temp.ministry_budget_code, &#xD;
	min_temp.ministry_org_name,min_temp.ministry_org_code,min_temp.new_percentage, min_temp.proj_budget_code,&#xD;
	ROUND(CAST(&#xD;
	CASE&#xD;
		WHEN min_temp.percentage &gt; 0 &#xD;
			THEN (min_temp.percentage/100)*fund_temp.transaction_amount&#xD;
		ELSE &#xD;
		(&#xD;
			(100-sum(min_temp.new_percentage) OVER (PARTITION BY min_temp.activity))&#xD;
			/&#xD;
			(min_temp.count2-min_temp.count1)&#xD;
		)/100 *fund_temp.transaction_amount&#xD;
	END AS numeric),3) &#xD;
	AS final_transaction_amount&#xD;
 &#xD;
 FROM &#xD;
	(select vf.amp_fund_detail_id,vf.transaction_date,&#xD;
	  &#xD;
	  (CASE &#xD;
		WHEN vf.currency_code='NPR' THEN 1.0&#xD;
		ELSE &#xD;
			getExchangeWithFixed('NPR',vf.transaction_date, vf.fixed_exchange_rate)/getExchangeWithFixed(vf.currency_code,vf.transaction_date, vf.fixed_exchange_rate)&#xD;
			   &#xD;
	    END)*vf.transaction_amount AS transaction_amount&#xD;
	  , &#xD;
	  concat(vf.mode_of_payment_name,' - ',vf.terms_assist_name) as source_name, &#xD;
	  concat(vf.mode_of_payment_id, '-',vf.terms_assist_id) as source_code, &#xD;
	  o.name as org_name, o.org_code as org_code, o.budget_org_code as budget_code, &#xD;
	  st.source_type_name, st.source_type_code&#xD;
 &#xD;
	  from v_donor_funding vf left join n_source_type st on &#xD;
	  (vf.terms_assist_name=st.type_of_assistance AND vf.mode_of_payment_name=st.mode_of_payment), &#xD;
	  amp_organisation o &#xD;
	  -- change the activity&#xD;
	  where vf.amp_activity_id = $parent and vf.org_id=o.amp_org_id and vf.transaction_type = 1 &#xD;
	    and vf.adjustment_type_name='Planned' and &#xD;
		vf.transaction_date &gt;= '${startDate} 00:00:00' AND vf.transaction_date &lt; '${endDate} 00:00:00'&#xD;
	) AS fund_temp,&#xD;
 &#xD;
	(select r.activity,r.percentage, r.organisation, &#xD;
		concat(o.budget_org_code,r.budget_code) as proj_budget_code,&#xD;
		o.budget_org_code as ministry_budget_code, &#xD;
		o.name as ministry_org_name, o.org_code as ministry_org_code,&#xD;
		CASE&#xD;
			WHEN r.percentage &gt; 0 THEN r.percentage&#xD;
			ELSE 0&#xD;
		END&#xD;
		as new_percentage,&#xD;
		count(CASE WHEN r.percentage&gt;0 THEN TRUE ELSE NULL END)  OVER (PARTITION BY r.activity ) as count1, &#xD;
		count(r.amp_org_role_id)  OVER (PARTITION BY r.activity ) as count2 &#xD;
		-- change the role and activity !!!!!!!!!!!!!!!!&#xD;
		from amp_org_role r, amp_organisation o&#xD;
		WHERE r.organisation=o.amp_org_id AND role=13 AND r.activity=$parent ) as min_temp;</query>
            <field ref="period-start">
                <content type="column">transaction_date</content>
                <attribute type="column" ref="iso-date">transaction_date</attribute>
                <query/>
            </field>
            <field ref="value">
                <content type="column">transaction_amount</content>
                <attribute type="constant" ref="currency">NPR</attribute>
                <attribute type="column" ref="value-date">transaction_date</attribute>
                <query/>
            </field>
            <field ref="provider-org">
                <content type="column">org_name</content>
                <attribute type="column" ref="ref">org_code</attribute>
                <attribute type="column" ref="budget-ref">budget_code</attribute>
                <query/>
            </field>
            <field ref="receiver-org">
                <content type="column">ministry_org_name</content>
                <attribute type="column" ref="ref">ministry_org_code</attribute>
                <attribute type="column" ref="budget-ref">ministry_budget_code</attribute>
                <query/>
            </field>
            <field ref="source-type">
                <content type="column">source_type_name</content>
                <attribute type="column" ref="code">source_type_code</attribute>
                <query/>
            </field>
            <field ref="receiver-activity-id">
                <content type="column">proj_budget_code</content>
                <query/>
            </field>
        </field>
        <field ref="transaction">
            <content type="constant">novalue</content>
            <query>-- Actual Disbursements&#xD;
SELECT fund_temp.*, min_temp.ministry_budget_code, min_temp.proj_budget_code,&#xD;
	min_temp.ministry_org_name,min_temp.ministry_org_code,min_temp.new_percentage,&#xD;
	ROUND(CAST(&#xD;
	CASE&#xD;
		WHEN min_temp.percentage &gt; 0 &#xD;
			THEN (min_temp.percentage/100)*fund_temp.transaction_amount&#xD;
		ELSE &#xD;
		(&#xD;
			(100-sum(min_temp.new_percentage) OVER (PARTITION BY min_temp.activity))&#xD;
			/&#xD;
			(min_temp.count2-min_temp.count1)&#xD;
		)/100 *fund_temp.transaction_amount&#xD;
	END AS numeric),3) &#xD;
	AS final_transaction_amount&#xD;
 &#xD;
 FROM &#xD;
	(select vf.amp_fund_detail_id,vf.transaction_date,&#xD;
	  &#xD;
	  (CASE &#xD;
		WHEN vf.currency_code='NPR' THEN 1.0&#xD;
		ELSE &#xD;
			getExchangeWithFixed('NPR',vf.transaction_date, vf.fixed_exchange_rate)/getExchangeWithFixed(vf.currency_code,vf.transaction_date, vf.fixed_exchange_rate)&#xD;
			   &#xD;
	    END)*vf.transaction_amount AS transaction_amount&#xD;
	  , &#xD;
	  concat(vf.mode_of_payment_name,' - ',vf.terms_assist_name) as source_name, &#xD;
	  concat(vf.mode_of_payment_id, '-',vf.terms_assist_id) as source_code, &#xD;
	  o.name as org_name, o.org_code as org_code, o.budget_org_code as budget_code, &#xD;
	  st.source_type_name, st.source_type_code&#xD;
 &#xD;
	  from v_donor_funding vf left join n_source_type st on &#xD;
	  (vf.terms_assist_name=st.type_of_assistance AND vf.mode_of_payment_name=st.mode_of_payment), &#xD;
	  amp_organisation o &#xD;
	  -- change the activity&#xD;
	  where vf.amp_activity_id = $parent and vf.org_id=o.amp_org_id and vf.transaction_type = 1 &#xD;
	    and vf.adjustment_type_name='Actual' and &#xD;
		vf.transaction_date &gt;= '${startDate} 00:00:00' AND vf.transaction_date &lt; '${endDate} 00:00:00'&#xD;
	) AS fund_temp,&#xD;
 &#xD;
	(select r.activity,r.percentage, r.organisation, &#xD;
		concat(o.budget_org_code,r.budget_code) as proj_budget_code,&#xD;
		o.budget_org_code as ministry_budget_code, &#xD;
		o.name as ministry_org_name, o.org_code as ministry_org_code,&#xD;
		CASE&#xD;
			WHEN r.percentage &gt; 0 THEN r.percentage&#xD;
			ELSE 0&#xD;
		END&#xD;
		as new_percentage,&#xD;
		count(CASE WHEN r.percentage&gt;0 THEN TRUE ELSE NULL END)  OVER (PARTITION BY r.activity ) as count1, &#xD;
		count(r.amp_org_role_id)  OVER (PARTITION BY r.activity ) as count2 &#xD;
		-- change the role and activity !!!!!!!!!!!!!!!!&#xD;
		from amp_org_role r, amp_organisation o&#xD;
		WHERE r.organisation=o.amp_org_id AND role=13 AND r.activity=$parent ) as min_temp;</query>
            <field ref="transaction-type">
                <content type="constant">Disbursement</content>
                <attribute type="constant" ref="code">D</attribute>
                <query/>
            </field>
            <field ref="provider-org">
                <content type="column">org_name</content>
                <attribute type="column" ref="ref">org_code</attribute>
                <attribute type="column" ref="budget-ref">budget_code</attribute>
                <query/>
            </field>
            <field ref="receiver-org">
                <content type="column">ministry_org_name</content>
                <attribute type="column" ref="ref">ministry_org_code</attribute>
                <attribute type="column" ref="budget-ref">ministry_budget_code</attribute>
                <query/>
            </field>
            <field ref="value">
                <content type="column">transaction_amount</content>
                <attribute type="constant" ref="currency">NPR</attribute>
                <attribute type="column" ref="value-date">transaction_date</attribute>
                <query/>
            </field>
            <field ref="flow-type">
                <content type="column">source_name</content>
                <attribute type="column" ref="code">source_code</attribute>
                <query/>
            </field>
            <field ref="source-type">
                <content type="column">source_type_name</content>
                <attribute type="column" ref="code">source_type_code</attribute>
                <query/>
            </field>
            <field ref="receiver-activity-id">
                <content type="column">proj_budget_code</content>
                <query/>
            </field>
        </field>
    </mapping>
    <global-settings/>
</iati-api-mapping>
